<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Apache Shiro 反序列化漏洞原理 | 个人博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/wangdengdeng/favicon.ico">
    <meta name="description" content="个人博客">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/wangdengdeng/assets/css/0.styles.aece1d96.css" as="style"><link rel="preload" href="/wangdengdeng/assets/js/app.3ead440b.js" as="script"><link rel="preload" href="/wangdengdeng/assets/js/6.e2e47644.js" as="script"><link rel="preload" href="/wangdengdeng/assets/js/22.5246510c.js" as="script"><link rel="prefetch" href="/wangdengdeng/assets/js/10.1b19dda1.js"><link rel="prefetch" href="/wangdengdeng/assets/js/11.90a6197a.js"><link rel="prefetch" href="/wangdengdeng/assets/js/12.ec953b45.js"><link rel="prefetch" href="/wangdengdeng/assets/js/13.91309f29.js"><link rel="prefetch" href="/wangdengdeng/assets/js/14.46d74e6d.js"><link rel="prefetch" href="/wangdengdeng/assets/js/15.c2d45576.js"><link rel="prefetch" href="/wangdengdeng/assets/js/16.543c64f2.js"><link rel="prefetch" href="/wangdengdeng/assets/js/17.15cac768.js"><link rel="prefetch" href="/wangdengdeng/assets/js/18.90b9c462.js"><link rel="prefetch" href="/wangdengdeng/assets/js/19.fe2d4f51.js"><link rel="prefetch" href="/wangdengdeng/assets/js/2.53fca3c4.js"><link rel="prefetch" href="/wangdengdeng/assets/js/20.bfd6aebf.js"><link rel="prefetch" href="/wangdengdeng/assets/js/21.515867c5.js"><link rel="prefetch" href="/wangdengdeng/assets/js/23.27aafa76.js"><link rel="prefetch" href="/wangdengdeng/assets/js/24.afd0d259.js"><link rel="prefetch" href="/wangdengdeng/assets/js/25.b06b9259.js"><link rel="prefetch" href="/wangdengdeng/assets/js/26.256455b7.js"><link rel="prefetch" href="/wangdengdeng/assets/js/27.aa0ca491.js"><link rel="prefetch" href="/wangdengdeng/assets/js/28.5e0e29c0.js"><link rel="prefetch" href="/wangdengdeng/assets/js/3.cb810e63.js"><link rel="prefetch" href="/wangdengdeng/assets/js/4.6efe2eb7.js"><link rel="prefetch" href="/wangdengdeng/assets/js/5.63f29a16.js"><link rel="prefetch" href="/wangdengdeng/assets/js/7.8704393b.js"><link rel="prefetch" href="/wangdengdeng/assets/js/8.4837a75b.js"><link rel="prefetch" href="/wangdengdeng/assets/js/9.5a7ccf82.js">
    <link rel="stylesheet" href="/wangdengdeng/assets/css/0.styles.aece1d96.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout" data-v-7f2e4136><header class="header-container" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/wangdengdeng/post-bg.jpeg);" data-v-93921ff8 data-v-7f2e4136><nav class="navbar" style="position:absolute;opacity:1;transition:all 0.5s ease-in-out;" data-v-93921ff8><a href="/wangdengdeng/" class="navbar-link router-link-active">
    
  </a> <ul class="navbar-links"><li><a href="/wangdengdeng/" class="router-link-active">
        主页
      </a></li><li><a href="/wangdengdeng/about/">
        关于作者
      </a></li><li><a href="/wangdengdeng/tags/">
        技术栈
      </a></li></ul> <div id="nav-icon"><span></span><span></span><span></span></div></nav> <div class="header-title" data-v-93921ff8 data-v-93921ff8><h1 data-v-93921ff8>Apache Shiro 反序列化漏洞原理</h1> <p data-v-93921ff8></p></div></header> <div class="container" data-v-b3fda33c data-v-7f2e4136><main class="main" style="width:60%;" data-v-b3fda33c><div class="post" data-v-b3fda33c data-v-b3fda33c><article class="main-div"><div class="post-content content content__default"><p>本篇博客作为课程设计-Shiro的漏洞检测利用系统的原理介绍</p> <h1 id="apache-shiro-反序列化漏洞原理详解"><a href="#apache-shiro-反序列化漏洞原理详解" class="header-anchor">#</a> Apache Shiro 反序列化漏洞原理详解</h1> <h2 id="apache-shiro简介"><a href="#apache-shiro简介" class="header-anchor">#</a> Apache shiro简介</h2> <p>Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。使用Shiro的易于理解的API,您可以快速、轻松地获得任何应用程序,从最小的移动应用程序到最大的网络和企业应用程序。</p> <p>本文针对Shiro进行了一个原理性的讲解，从源码层面来分析了Shiro的认证和授权的整个流程，并在认证与授权的这个流程讲解冲，穿插说明rememberme的作用，以及为何该字段会导致反序列化漏洞。</p> <h2 id="apache-shiro认证"><a href="#apache-shiro认证" class="header-anchor">#</a> Apache shiro认证</h2> <p>在该小节中我们将会详细讲解Shiro是如何认证一个用户为合法用户的</p> <p>Shiro漏洞环境测试代码修改自Vulhub中的CVE-2016-4437。</p> <p>首先是Shiro的配置文件，代码如下所示</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShiroConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">MainRealm</span> <span class="token function">mainRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MainRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RememberMeManager</span> <span class="token function">cookieRememberMeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">RememberMeManager</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">CookieRememberMeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">SecurityManager</span> <span class="token function">securityManager</span><span class="token punctuation">(</span><span class="token class-name">MainRealm</span> mainRealm<span class="token punctuation">,</span> <span class="token class-name">RememberMeManager</span> cookieRememberMeManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultWebSecurityManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultWebSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        manager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Realm</span><span class="token punctuation">)</span>mainRealm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        manager<span class="token punctuation">.</span><span class="token function">setRememberMeManager</span><span class="token punctuation">(</span>cookieRememberMeManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">SecurityManager</span><span class="token punctuation">)</span>manager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;shiroFilter&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token class-name">ShiroFilterFactoryBean</span> <span class="token function">shiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">SecurityManager</span> securityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ShiroFilterFactoryBean</span> bean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bean<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>securityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置登录页面uri</span>
        bean<span class="token punctuation">.</span><span class="token function">setLoginUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置登录失败页面uri</span>
        bean<span class="token punctuation">.</span><span class="token function">setUnauthorizedUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/unauth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​
        <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token operator">&gt;</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/doLogin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;anon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/doLogout&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;authc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/add&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;perms[user:add]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/update&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;perms[user:update]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/delete&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;perms[user:delete]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/select&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;perms[user:select]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;authc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​
        bean<span class="token punctuation">.</span><span class="token function">setFilterChainDefinitionMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
​
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后是Controller的代码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/doLogin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doLoginPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;rememberme&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> rememberMe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            subject<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> rememberMe<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;remember-me&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;forward:/login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/doLogout&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doLogout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subject<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/login&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">helloPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/unauth&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">errorPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/user/add&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/user/add&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
​
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/user/delete&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/user/delete&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
​
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/user/update&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/user/update&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
​
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;/user/select&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/user/select&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
​
<span class="token punctuation">}</span>
</code></pre></div><p>最后是Realm</p> <p>这里来看一下自定义的MainRealm的类继承和实现关系图</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602240865_1.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602240865_1.png" alt="1"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Realm所起到的作用通常是获取后台用户的相关信息，然后获取前端传递进来的用户信息，将二者封装好然后交由shiro进行认证比对从而判断用户是否为合法用户，然后在用户访问后台资源时，为用户授予指定好的权限。</p> <p>那么认证是怎么认证的呢？下面来从Shiro源码的角度来进行详细的分析。</p> <p>首先是登陆页面，和登陆页面的代码。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602392228_2.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602392228_2.png" alt="2"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>当点击Singn in按钮的时候 后台对应的Controller就会执行</p> <p>但是在执行到Controller之前，Shiro会进行一个操作，如下所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602393930_3.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602393930_3.png" alt="3"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>首先就是Shiro的Filter，在Shiro的配置文件中，通过@Bean注解让SpringBoot在启动的时候自动装配了当前方法的返回值，也就是一个ShiroFilterFactoryBean对象，该对象的类继承关系如下所示。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602400839_4.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602400839_4.png" alt="4"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>该类实现了SpringFrameWork中的FactoryBean接口和BeanPostProcessor接口。SpringBoot在启动的时候会扫描当前目录以及子目录下所有.java文件的注解，然后进行装配，这一过程中就会调用FactoryBean.getObject()方法。也就是FactoryBean的实现类ShiroFilterFactoryBean.getObject()方法，</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/202112160240127_5.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/202112160240127_5.png" alt="5"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在shiroFilter的执行的堆栈中，会创建一个Subject，Subject是Shiro中很重要的一个概念，简单来说就是当前所操作的用户。当前线程中的用户所进行的认证和授权等等操作，都会以操作这个Subject对象来进行，所以Subject也被称之为主体，最终实例化的是一个WebDelegatingSubject对象。</p> <p>请求继续往下执行，来到UserController.doLoginPage()方法，该方法中会调用Subject.login()方法，并传入一个UsernamePasswordToken 对象。这个UsernamePasswordToken从这个类的名字我们就可以猜出这个类是用来做什么的，跟进该类中看一下</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602401694_6.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602401694_6.png" alt="6"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>从这个类提供的方法和属性就可以看出来，UsernamePasswordToken类就是一个单纯的pojo类，登陆时的用户名和密码以及对应的ip信息都会在这个类中暂时存放。</p> <p>跟进Subject.login()方法，经过一系列的调用来到了ModularRealmAuthenticator.doAuthenticate，该方法会获取我们自定义的Realm并一次进行调用，我们自定义的Realm是文章开头的MainRealm，所谓的Realm，就是对传入的用户进行认证和授权的地方，Realm的自定义需要继承自AuthorizingRealm，Realm我们可以自定义多个，只需要将自定义好的多个Realm放入一个Collection对象中，然后在配置文件中通过SecurityManager.setRealms()传入，这样在Shiro在认证时就会依次调用我们自定义的Realms，Shiro本身也自带有一些Reamls可以直接调用，如下图所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602402050_7.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602402050_7.png" alt="7"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>自定义的Realm有两个方法必须要实现，分别是继承自AuthencationgRealm的doGetAuthenticationInfo()方法，和AuthorizingRealm的doGetAuthorizationInfo方法，如下图所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602402390_8.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602402390_8.png" alt="8"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>下面根据程序执行流程，先讲doGetAuthenticationInfo，根据之前所讲调用subject.login()方法时会调用到我们自定义的Realm的doGetAuthenticationInfo方法，我们在该方法中的实现非常简单，即从后台数据库中根据用户名进行查询用户是否存在，如果存在则将查询出来的数据封装成Users对象，然后将封装好的Users对象传入和查询出的该用户的密码一同传入SimpleAuthenticationInfo类构造方法中并进行返回。</p> <p>这一步说是用来进行用户的认证，但是不难发现，该方法中并没有对用户的密码进行校验，那么真正的校验点在哪里呢，在如下图所示的位置</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602402775_9.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602402775_9.png" alt="9"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在AuthenticatingRealm的getAuthenticationInfo方法中不仅调用了我们自定义的MainRealm中的doGetAuthenticationInfo方法，还调用了自身的assertCredentialsMatch方法，如下图所示，而assertCredentialsMatch方法就是用来校验前端传递来的用户名和密码，以及后台从数据库查询出的密码进行比对的。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/202112160240304_10.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/202112160240304_10.png" alt="10"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在assertCredentialsMatch方法中跟如cm.doCredentialsMatch(token, info)，然后就可以看到shiro如何进行用户密码比对的了。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602403477_11.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602403477_11.png" alt="11"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>token是前端传入的用户名和密码封装成的UsernamePasswordToken对象，info是从数据库中查询出的数据封装成的SimpleAuthenticationInfo对象，如此一来，获取二者的密码，进行equals比对，相同则程序继续执行，不相同则抛出异常，返回登陆界面。</p> <p>那么Shiro认证到这里就结束了么？当然不是，之前提到过，Shiro中有一个概念叫Subject，Subject代表的就是用户当前操作的主体，在这第一次登陆认证中我们也是通过调用了一个Subject对象的login方法才进行的身份验证，但是在这个Subject中是没有任何的用户信息的，当用户的信息通过校验之后，Shiro又会实例化一个WebDelegatingSubject，而这个位置就在DefaultSecurityManager的login方法中，如下图所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602403854_12.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602403854_12.png" alt="12"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>我们之前看到的认证过程就在authenticate方法里，身份真正成功后会返回用户的信息，封装在一个SimplePrincipalCollection对象里，如果认证失败，则会抛出异常。</p> <p>认证成功后，Shiro就会根据当前用户的一些信息，再创建一个Subject，后续该用户进行的任何操作都会以这个Subject为主，授权也是Shiro给这个Subject进行授权。</p> <p>如此以来我们就了解了Shiro是如何认证一个用户的，下面来总结一下Shiro认证用户的一个思路，首先在用户没有进行认证的时候访问一些资源，Shiro会生成一个Subject，这个Subject没有任何的用户信息。当用户开始登陆，Shiro会调用Subject的login方法，对用户的用户名和密码进行校验，校验通过后，会生成一个新的Subject，后续用户的授权等操作，都会基于这个新生成的Subject。</p> <h2 id="apache-shiro授权"><a href="#apache-shiro授权" class="header-anchor">#</a> Apache Shiro授权</h2> <p>看完了Shiro的认证过程，接下来我们来看Shiro的授权过程。</p> <p>我们将每位用户所拥有的授权都存入数据库中如下所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602404166_13.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602404166_13.png" alt="13"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这里以admin为例，来分析下Shiro授权的过程。</p> <p>书接上文Shiro认证部分，认证完成功Shiro会生成一个新的Subject，而shiro的授权过程也就是围绕着这个Subject来进行的，那么Shiro何时会为用户进行授权行为呢？</p> <p>在之前的内容中说过，自定义的Realm有两个方法必须要实现，分别是继承自AuthencationgRealm的doGetAuthenticationInfo()方法，和AuthorizingRealm的doGetAuthorizationInfo方法。</p> <p>doGetAuthenticationInfo()方法我们已经清楚了，是用来进行用户身份验证的，而doGetAuthorizationInfo()方法就是用来进行用户授权的。</p> <p>再回顾一下之前的配置文件中我们为每个资源所授予的访问权限，权限如下所示。</p> <table><thead><tr><th>1234567891011121314151617181920212223242526</th> <th>@Bean(name = {&quot;shiroFilter&quot;})   ShiroFilterFactoryBean shiroFilterFactoryBean(SecurityManager securityManager) {     ShiroFilterFactoryBean bean = new ShiroFilterFactoryBean();     bean.setSecurityManager(securityManager);     bean.setLoginUrl(&quot;/login&quot;);     bean.setUnauthorizedUrl(&quot;/unauth&quot;);     /**     * anon:无需认证就可以访问     * authc: 必须认证了才能访问     * user: 必须拥有记住我功能才能访问     * perms: 拥有对某个资源的权限才能访问     * role: 拥有某个角色权限才能访问     * */     Map&lt;string, string=&quot;&quot;&gt; map = new LinkedHashMap&lt;&gt;();     map.put(&quot;/doLogin&quot;, &quot;anon&quot;);     map.put(&quot;/doLogout&quot;, &quot;authc&quot;);     map.put(&quot;/user/add&quot;,&quot;perms[user:add]&quot;);     map.put(&quot;/user/update&quot;,&quot;perms[user:update]&quot;);     map.put(&quot;/user/delete&quot;,&quot;perms[user:delete]&quot;);     map.put(&quot;/user/select&quot;,&quot;perms[user:select]&quot;);     map.put(&quot;/**&quot;, &quot;authc&quot;);     bean.setFilterChainDefinitionMap(map);     return bean;   }</th></tr></thead> <tbody><tr><td></td> <td></td></tr></tbody></table> <p>我们在doGetAuthorizationInfo()方法中下断点，当已经经过认证的用户访问制定资源的时候，shiro就会调用doGetAuthorizationInfo()方法来为该用户进行授权，具体怎么执行到该方法的就不细说了，将调用链粘贴一下。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602404554_14.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602404554_14.png" alt="14"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>doGetAuthorizationInfo()方法的具体实现如下所示</p> <table><thead><tr><th>1234567891011121314151617181920212223</th> <th>protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {     String name = getName();     System.out.println(&quot;执行了=&gt;授权doGetAuthorizationInfo&quot;);     SimpleAuthorizationInfo info = new SimpleAuthorizationInfo();    //获取当前用户的subject     Subject subject = SecurityUtils.getSubject();     System.out.println(subject.isAuthenticated());     System.out.println(subject.isRemembered());     if(!subject.isAuthenticated()){       return null;     }//     Users users = userService.queryUserByName((String) subject.getPrincipal());    //    //获取当前用户的信息     Users users = (Users) subject.getPrincipal();   //判断当前用户的权限字段是否为空，如果不为空的话就传入SimpleAuthorizationInfo的addStringPermissions方法中。     if(users.getPerm()!=null){       String[] prems = users.getPerm().split(&quot;;&quot;);       info.addStringPermissions(Arrays.asList(prems));     }     return info;   }</th></tr></thead> <tbody><tr><td></td> <td></td></tr></tbody></table> <p>之前在认证的那一步中，我们将数据库中的数据封装成一个Users对象，该对象存放入了Subject中，doGetAuthorizationInfo()方法中我们将其取出。</p> <p>在该方法中，我们所做的只是将用户数据库中的权限字段取出然后封装入一个SimpleAuthorizationInfo对象中，并进行返回，我们跟随看一下Shiro后续的操作。</p> <p>在获取完当前用户的权限后，堆栈返回到AuthorizingRealm的isPermitted方法中，该方法又调用了isPermitted()方法，isPermitted()方法就是用来判断用户是否有权限访问指定资源的方法。</p> <p>isPermitted()方法具体内容如下所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602404877_15.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602404877_15.png" alt="15"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>该方法会讲用户所拥有的权限循环遍历出来，然后和当前资源所需要访问权限进行一一比对，如果相同则返回true。那么比对规则是怎样的呢？</p> <p>跟进implies()方法，内容如下所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602405251_16.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602405251_16.png" alt="16"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这里简述一下比对的规则，当前资源所需的访问权限[user:add]，对于shiro来说所谓的访问权限不过就是一串字符串而已，shiro会将[user:add]以“:”进行分割，分割成user和add两个字符串，而假如用户具有[user:add],和[user:select]这两个权限，第一次循环就是判断[user:select]和[user:add]是否相同，会首先判断“:”之前的字符串是否相同，也就是user这部分是否相同，相同则继续，不相同则返回false。判断相同以后，会第二次循环判断“:”之后的部分是否相同，也就是add和select。那自然是不相同的，所以返回false。shiro接下来会继续判断[user:add]和[user:add]是否相同。</p> <p>这就是shiro授权和鉴权的代码流程，也是shiro的核心。了解了shiro的这部分内容之后，我们接下来就该讲CVE-2016-4437这个漏洞的具体内容了。</p> <h2 id="apahce-shiro反序列化漏洞的根源"><a href="#apahce-shiro反序列化漏洞的根源" class="header-anchor">#</a> Apahce Shiro反序列化漏洞的根源</h2> <p>shiro在用户登陆的时候，除了用户名和密码以外 还有一个可传递的选项，也就是shiro发序列化漏洞产生的根源，Rememberme。</p> <p>Rememberme的核心作用时什么呢？就是用户在登录时勾选rememberme选项，Cookie中就会增加一个rememberme字段，该字段中会存储一些序列化数据，开发者可以指定rememberme字段的有效时间，同时开发者可以指定一些资源，这些资源允许携带rememberme字段的用户访问，由于rememberme是存储在浏览器中的，并在用户的每一次请求中被携带，所以只要不清除Cookie，用户就可以在rememberme的有效时间内，无需再次登陆，就可以访问指定资源。在不勾选rememberme的情况下，通常就是浏览器关闭，会话就会立刻结束，活着等待一段时间后结束，届时用户想要访问一些资源则需要重新登陆，勾选rememberme后，即使推出浏览器结束与服务端的会话，rememberme仍然存储在浏览器中，重新打开浏览器访问指定资源，浏览器在请求时仍会携带上rememberme，如此一来就不需要重新登陆了。</p> <p>那么接下来就来分析rememberme是如何生成，以及如何实现无需登录即可访问指定资源的。</p> <p>如果登陆的时候不勾选rememberme选项的情况下，Shiro是不会生成rememberme的，勾选了rememberme选项后，才会在认证的过程中生成该值。</p> <p>生成rememberme的位置在DefaultSecurityManager的login方法中，如下图所示。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602405587_17.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602405587_17.png" alt="17"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>位置就是在Shiro完成用户认证，生成一个新的Subject之后。跟进onSuccessfulLogin()方法，经过嵌套调用，来到AbstractRememberMeManager的onSuccessfulLogin方法，</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602405994_18.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602405994_18.png" alt="18"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在该方法中，会先判断此次请求中remebmberme字段是否存在，如果存在则调用rememberIdentity()方法，想要知道rememberme中存储了什么东西那么就要继续深入。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602410224_19.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602410224_19.png" alt="19"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这里是获取到了一个PrincipalCollection对象，继续深入。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602410564_20.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602410564_20.png" alt="20"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>接下来就是将这个PrincipalCollection转化成byte数组。这个方法很关键，我们需要跟入看一下</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602410888_21.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602410888_21.png" alt="21"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>看到这里大家应该就明白了，Shiro为什么会有反序列化漏洞，以及rememberme所传递的数据就究竟是什么，其实就是一个序列化后的PrincipalCollection对象，而这个encrypt就是通过AES来加密序列化后的数据，密钥呢？当然就是硬编码在AbstractRememberMeManager类中的这段base64编码后的字符串了，如下图所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/202112160241111_22.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/202112160241111_22.png" alt="22"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>最后的最后，Shiro会将这段加密后的数据base64编码一遍，然后放入Cookie中，至此Shiro生成rememberme的过程就结束了</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602411476_23.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602411476_23.png" alt="23"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>那么知道了rememberme是怎么加密生成的，那么自然也就可以很轻易的解密了，尤其还是在密钥硬编码在代码中的这种情况，下面是解密的demo</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602411758_24.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602411758_24.png" alt="24"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>那么反序列化漏洞产生的点在哪里呢？当用户在登录时勾选了rememberme的时候，Shiro会返回一个rememberme通过Cookie字段传递，然后存储在浏览器中，正常情况下当用户关闭浏览器或者手动删除浏览器中存储的SesseionID的时候，与服务端的当前会话就结束了，当下次打开浏览器再此访问服务端的时候，就需要重新登录。而勾选了rememberme的用户登录后，关闭浏览器后，会话同样会关闭，但是下次打开浏览器请求访问服务端的时候，Cookie中会携带Rememberme来进行请求，从而达到无需登录的效果。</p> <p>漏洞的产生关键就在于再重新建立会话的这个过程，所以想要触发rememberme的话请求包中就不能有SessionID,删除SessionID后再携带rememberme进行一次请求就可以触发rememberme的反序列化点，如下图所示</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602412187_25.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602412187_25.png" alt="25"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>最终通过base64解码，然后AES解密，解密后的结果再经过反序列化，就还原成了一个PrincipalCollection对象，至此Shiro rememberme的生成以及作用，还有如何触发rememberme反序列化，都已讲解完毕。</p> <p><a href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602412496_26.png" target="_blank" rel="noopener noreferrer"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2021/12/2021121602412496_26.png" alt="26"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></article> <div class="main-div vssue"><!----></div></div></main> <aside class="aside" data-v-b3fda33c data-v-b3fda33c><div class="info-card main-div" data-v-1311ce9e data-v-b3fda33c><div class="info-card-header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/wangdengdeng/avatar-bg.jpeg);" data-v-1311ce9e><img src="/wangdengdeng/avatar-top.jpeg" alt="20046219-王敬泽" class="info-avatar" data-v-1311ce9e></div> <div class="info-card-body" data-v-1311ce9e><section class="info-name" data-v-1311ce9e>
      20046219-王敬泽
    </section> <section class="info-desc" data-v-1311ce9e>I am a slow walker, but I never walk backwards.<br/>道阻且长,行则将至</section> <section class="info-contact" data-v-1311ce9e><section data-v-1311ce9e><span data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:1em;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-location" data-v-1311ce9e data-v-1311ce9e></use></svg><span class="info-text" data-v-1311ce9e data-v-1311ce9e>
          China
        </span></span></section> <!----> <section data-v-1311ce9e><span data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:1em;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-email" data-v-1311ce9e data-v-1311ce9e></use></svg><span class="info-text" data-v-1311ce9e data-v-1311ce9e>
          1055192032@qq.com
        </span></span></section></section></div> <div class="info-card-footer" data-v-1311ce9e><p class="footer-sns-link" data-v-1311ce9e></p></div></div> <div class="post-toc main-div aside-toc" style="position:relative;top:0;width:0px;" data-v-b3fda33c><h4>- CATALOG</h4> <div class="post-nav-toc"><ul><li><a href="/wangdengdeng/posts/2023/05/20/shiro.html#apache-shiro简介">Apache shiro简介</a></li><li><a href="/wangdengdeng/posts/2023/05/20/shiro.html#apache-shiro认证">Apache shiro认证</a></li><li><a href="/wangdengdeng/posts/2023/05/20/shiro.html#apache-shiro授权">Apache Shiro授权</a></li><li><a href="/wangdengdeng/posts/2023/05/20/shiro.html#apahce-shiro反序列化漏洞的根源">Apahce Shiro反序列化漏洞的根源</a></li></ul></div></div></aside></div> <footer class="footer" data-v-7f2e4136><p class="footer-sns-link"></p> <div class="copyright"><span id="custom">Copyright &copy; WADE_2ng 2020 <br /> 
        Theme By <a href="https://www.vuepress.cn/" target="_blank">VuePress</a></span> <!----></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/wangdengdeng/assets/js/app.3ead440b.js" defer></script><script src="/wangdengdeng/assets/js/6.e2e47644.js" defer></script><script src="/wangdengdeng/assets/js/22.5246510c.js" defer></script>
  </body>
</html>
